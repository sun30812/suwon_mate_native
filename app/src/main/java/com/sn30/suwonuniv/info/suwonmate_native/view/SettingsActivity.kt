package com.sn30.suwonuniv.info.suwonmate_native.viewimport android.content.Intentimport android.os.Bundleimport android.util.Logimport android.view.Viewimport android.view.ViewGroupimport android.widget.*import androidx.appcompat.app.AppCompatActivityimport androidx.appcompat.widget.SwitchCompatimport androidx.core.view.ViewGroupCompatimport com.google.android.material.slider.Sliderimport com.google.android.material.switchmaterial.SwitchMaterialimport com.google.firebase.database.DataSnapshotimport com.google.firebase.database.DatabaseErrorimport com.google.firebase.database.ValueEventListenerimport com.google.firebase.database.ktx.databaseimport com.google.firebase.ktx.Firebaseimport com.sn30.suwonuniv.info.suwonmate_native.BuildConfigimport com.sn30.suwonuniv.info.suwonmate_native.Rimport com.sn30.suwonuniv.info.suwonmate_native.databinding.SettingsBindingimport com.sn30.suwonuniv.info.suwonmate_native.models.SettingStoreclass SettingsActivity: AppCompatActivity() {    private lateinit var pref: SettingStore    private lateinit var binding: SettingsBinding    private lateinit var majorSnapshot: DataSnapshot    override fun onCreate(savedInstanceState: Bundle?) {        pref = SettingStore(this)        val department: String = pref.getString("department", "컴퓨터학부")        val major: String = pref.getString("major", "컴퓨터SW")        super.onCreate(savedInstanceState)        binding = SettingsBinding.inflate(layoutInflater)        setContentView(binding.root)        supportActionBar?.setDisplayHomeAsUpEnabled(true)        binding.studentSettingTitle.titleIcon.setImageResource(R.drawable.ic_school)        binding.studentSettingTitle.title.setText(R.string.student_info)        val departmentsListAdapter = ArrayAdapter<String>(this, android.R.layout.simple_dropdown_item_1line)        val majorListAdapter = ArrayAdapter<String>(this, android.R.layout.simple_dropdown_item_1line)        val gradeListAdapter = ArrayAdapter(            this,            android.R.layout.simple_dropdown_item_1line,            resources.getStringArray(R.array.grades)        )        binding.departmentSetting.adapter = departmentsListAdapter        binding.majorSetting.adapter = majorListAdapter        binding.gradeSetting.adapter = gradeListAdapter        binding.gradeSetting.setSelection(pref.getInt("grade", 0))        val database = Firebase.database        val myRef = database.getReference("/departments")        binding.departmentSetting.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {            override fun onItemSelected(p0: AdapterView<*>?, p1: View?, p2: Int, p3: Long) {                majorListAdapter.clear()                majorSnapshot.child(binding.departmentSetting.selectedItem.toString()).children.forEach {                    majorListAdapter.add(it.value.toString())                    if (major == it.value.toString()) {                        binding.majorSetting.setSelection(majorListAdapter.count - 1)                    }                }                pref.setString("department", binding.departmentSetting.selectedItem.toString())            }            override fun onNothingSelected(p0: AdapterView<*>?) {                TODO("Not yet implemented")            }        }        myRef.addValueEventListener(object : ValueEventListener {            override fun onDataChange(snapshot: DataSnapshot) {                binding.studentLoading.visibility = View.VISIBLE                binding.departmentBar.visibility = View.GONE                binding.majorBar.visibility = View.GONE                departmentsListAdapter.clear()                majorSnapshot = snapshot                snapshot.children.forEach {                    departmentsListAdapter.add(it.key.toString())                    if (department == it.key.toString()) {                        binding.departmentSetting.setSelection(departmentsListAdapter.count - 1)                    }                }                binding.studentLoading.visibility = View.GONE                binding.departmentBar.visibility = View.VISIBLE                binding.majorBar.visibility = View.VISIBLE                binding.gradeBar.visibility = View.VISIBLE            }            override fun onCancelled(error: DatabaseError) {                TODO("Not yet implemented")            }        })        binding.gradeSetting.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {            override fun onItemSelected(p0: AdapterView<*>?, p1: View?, p2: Int, p3: Long) {                pref.setInt("grade", p2)            }            override fun onNothingSelected(p0: AdapterView<*>?) {                TODO("Not yet implemented")            }        }        binding.majorSetting.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {            override fun onItemSelected(p0: AdapterView<*>?, p1: View?, p2: Int, p3: Long) {                pref.setString("major", binding.majorSetting.selectedItem.toString())            }            override fun onNothingSelected(p0: AdapterView<*>?) {                TODO("Not yet implemented")            }        }        val table = TableLayout(this)        val tableRow = TableRow(this)        table.addView(tableRow)        val dataSaveMode = SwitchMaterial(this)        dataSaveMode.width = ViewGroup.LayoutParams.MATCH_PARENT        dataSaveMode.height = ViewGroup.LayoutParams.WRAP_CONTENT        dataSaveMode.text = "데이터 절약 모드"        dataSaveMode.isChecked = pref.getBool("dataSaver", false)        dataSaveMode.setOnCheckedChangeListener { _, isChecked ->                pref.setBool("dataSaver", isChecked)        }        val liveSearchSlider = Slider(this)        val liveSearch = SwitchMaterial(this)        liveSearch.text = "입력하여 바로 검색"        liveSearch.width = ViewGroup.LayoutParams.MATCH_PARENT        liveSearch.height = ViewGroup.LayoutParams.WRAP_CONTENT        liveSearch.isChecked = pref.getBool("liveSearch", false)        liveSearch.setOnCheckedChangeListener { _, isChecked ->            pref.setBool("liveSearch", isChecked)            if (isChecked) liveSearchSlider.visibility = View.VISIBLE else liveSearchSlider.visibility = View.GONE        }        liveSearchSlider.visibility = if (liveSearch.isChecked) View.VISIBLE else View.GONE        liveSearchSlider.value = pref.getInt("liveSearchCount", 0).toFloat()        liveSearchSlider.valueFrom = 0.0F        liveSearchSlider.valueTo = 3.0F        liveSearchSlider.stepSize = 1.0F        liveSearchSlider.addOnChangeListener { _, value, _ ->            pref.setInt("liveSearchCount", value.toInt())        }        binding.functionSettings.titleBar.titleIcon.setImageResource(R.drawable.ic_settings)        binding.functionSettings.titleBar.title.text = "기능 설정"        binding.functionSettings.contents.addView(dataSaveMode)        binding.functionSettings.contents.addView(liveSearch)        binding.functionSettings.contents.addView(liveSearchSlider)        binding.resetMenu.titleBar.titleIcon.setImageResource(R.drawable.ic_reset)        binding.resetMenu.titleBar.title.text = "초기화 메뉴"        binding.versionInfo.titleBar.titleIcon.setImageResource(R.drawable.ic_info)        binding.versionInfo.titleBar.title.text = "버전 정보"        var dbVersion = getString(R.string.unknown)        val version = database.getReference("version/db_version")        version.addValueEventListener(object : ValueEventListener {            override fun onDataChange(snapshot: DataSnapshot) {                dbVersion = snapshot.value.toString()            }            override fun onCancelled(error: DatabaseError) {                dbVersion = getString(R.string.db_get_err)            }        })        val versionInfoMessage = TextView(this)        versionInfoMessage.text = getString(R.string.version_desc, BuildConfig.VERSION_NAME, dbVersion)        binding.versionInfo.contents.addView(versionInfoMessage)        binding.emailButton.setOnClickListener {            val sendMail = Intent(Intent.ACTION_SEND)            sendMail.type = "text/plain"            sendMail.setPackage("com.google.android.gm")            sendMail.putExtra(Intent.EXTRA_EMAIL, "orgsun30812+suwon_mate@gmail.com")            sendMail.putExtra(Intent.EXTRA_SUBJECT, "수원 메이트(네이티브) 버그 및 건의")            startActivity(sendMail)        }    }}